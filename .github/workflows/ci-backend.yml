name: CI - Backend (Monorepo Maven)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.name-suffix }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - service: all
            maven-args: clean verify -B -T 1C
            name-suffix: All Services
          - service: auth-service
            maven-args: clean verify -pl auth-service -am -B -T 1C
            name-suffix: Auth Service only
          - service: product-service
            maven-args: clean verify -pl product-service -am -B -T 1C
            name-suffix: Product Service only

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: üîç Build & Test
        run: mvn ${{ matrix.maven-args }}
        env:
          SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;MODE=PostgreSQL
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_DATASOURCE_PASSWORD: ""
          JWT_SECRET: test-secret-key-for-ci-cd-pipeline-123456
          JWT_EXPIRATION: 3600000

      - name: ‚úÖ Success message
        if: success()
        run: |
          echo "üéâ ${{ matrix.name-suffix }} tests passed!"
          echo "üì¶ Build completed successfully"
          echo "üöÄ CI is green for ${{ matrix.service }}!"